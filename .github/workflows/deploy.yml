name: Deploy

on:
  workflow_dispatch:
    inputs:
      target_host:
        description: "Override target host/IP (optional)"
        required: false
        type: string
  push:
    branches: [ main ]

jobs:
  ansible-deploy:
    name: Ansible deploy
    runs-on: ubuntu-latest
    env:
      ANSIBLE_CONFIG: django-deploy-aws/ansible.cfg
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Prepare SSH key
        shell: bash
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/gh_actions.pem
          chmod 600 ~/.ssh/gh_actions.pem

      - name: Prepare inventory (optional override)
        if: ${{ github.event.inputs.target_host != '' || secrets.TARGET_HOST != '' }}
        shell: bash
        env:
          INPUT_TARGET_HOST: ${{ github.event.inputs.target_host }}
          SECRET_TARGET_HOST: ${{ secrets.TARGET_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          HOST=${INPUT_TARGET_HOST:-$SECRET_TARGET_HOST}
          echo "[webservers]" > inventory.ini
          echo "$HOST ansible_user=${SSH_USER:-ubuntu} ansible_ssh_private_key_file=~/.ssh/gh_actions.pem" >> inventory.ini
          cat inventory.ini

      - name: Add host key to known_hosts
        if: ${{ github.event.inputs.target_host != '' || secrets.TARGET_HOST != '' }}
        shell: bash
        env:
          INPUT_TARGET_HOST: ${{ github.event.inputs.target_host }}
          SECRET_TARGET_HOST: ${{ secrets.TARGET_HOST }}
        run: |
          HOST=${INPUT_TARGET_HOST:-$SECRET_TARGET_HOST}
          ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Run Ansible deploy
        shell: bash
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          set -euo pipefail
          INVENTORY_ARG="-i django-deploy-aws/ansible/hosts.ini"
          if [ -f inventory.ini ]; then INVENTORY_ARG="-i inventory.ini"; fi
          ansible --version
          ansible-playbook $INVENTORY_ARG --private-key ~/.ssh/gh_actions.pem \
            -e ansible_user=${SSH_USER:-ubuntu} \
            django-deploy-aws/ansible/deploy.yml
